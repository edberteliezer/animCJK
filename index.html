<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="initial-scale=1.0,user-scalable=yes">
<meta name="description" content="Demo to animate several AnimCJK SVG
representing Japanese or Chinese characters">
<link rel="stylesheet" href="css/style.css" type="text/css">
<link rel="stylesheet" href="css/matter.css" type="text/css">
<title>AnimCJK - Minimal</title>
<script src="js/codePoint.js"></script>
<script>
var msg=[];
msg[0]="generateStroke('<insert>') Remember to use the quotation mark";
msg[1]="Error!";
msg[2]="No data!";
msg[3]="Svg not in selected repository!";
msg[4]="Too many characters in the data field (4 is the limit)!";
function status(s,a)
{
	var e;
	if (e=document.getElementById("status"));
		if (a) console.log(s);
		console.log(s);
}
function magicStringToArray(s)
{
	var s2,reg,k,a;
	s2=s;
	k=0;
	a=[];
	while (s2.length)
	{
		a[k]=String.fromCodePoint(s2.codePointAt(0));
		reg=new RegExp('^'+a[k]);
		s2=s2.replace(reg,'');
		k++;
	}
	return a;
}
function magicStringLength(s)
{
	return magicStringToArray(s).length;
}
function magicSubstring(s,k1,k2)
{
	var a,k,ko,km,r;
	if (!k1) ko=0; else ko=k1;
	if (!k2) km=4; else km=k2;
	a=magicStringToArray(s);
	km=Math.min(km,a.length);
	r='';
	for (k=ko;k<km;k++) r+=a[k];
	return r;
}
function getLang()
{
	return document.getElementsByTagName('html')[0].getAttribute('lang');
}
function isCharInRepository(c,lang)
{
	// look at the corresponding section
	var id,s,e;
	if (lang=="ja") id="jaSection";
	else if (lang=="ja-special") id="jaSpecialSection";
	else if (lang=="ja-kana") id="jaKanaSection";
	else if (lang=="zh-hans") id="zhHansSection";
	else id="zhHantSection";
	e=document.getElementById(id);
	if (e) s=document.getElementById(id).innerHTML;
	else s="";
	return (s.indexOf(c)>=0);
}

var pitiful=-1;
var currentRun=[];
var currentStrokes=[];
var currentPitiful=0;
function forceReflow()
{
	// for all browsers
	// force a reflow to restart animation
	void(document.getElementById('a').offsetHeight);
}
function getDelay(e)
{
	var a,m;
	// if the delay is already stored in the "data-d" attribute, just return it
	a=e.getAttributeNS(null,"data-d");
	if (a) return parseFloat(a);
	// otherwise return the "--d" css variable value
	a=e.getAttributeNS(null,"style");
	if (a&&(m=a.match(/--d:([^;]+);/))) return parseFloat(m[1]);
	// some browsers may remove "--d" from the "style" attribute (pitifulest browsers)
	// then get the stroke number from the id of the clip-path element as a workaround
	a=e.getAttributeNS(null,"clip-path");
	if (a&&(m=a.match(/c([0-9]+)[^0-9]/))) return parseInt(m[1]);
	return -1; // error
}
function pitifulOne(n)
{
	var k,km;
	km=currentStrokes.length;
	for (k=0;k<km;k++)
	{
		if (k>n) currentStrokes[k].style.fill="none";
		else currentStrokes[k].style.fill="#000";
	}
}
function pitifulSeveral(dt)
{
	var iframes,ki,kim,list,k,km,list1,list2,ks,idocument;
	iframes=document.getElementById('a').getElementsByTagName("iframe");
	if (!iframes||!iframes.length) return;
	kim=iframes.length;
	ks=0;
	for (ki=0;ki<kim;ki++)
	{
		idocument=iframes[ki].contentDocument;
		list1=idocument.querySelectorAll("svg.acjk path[id]");
		// use "clip-path" because it exists only the 1st time one comes here
		list2=idocument.querySelectorAll("svg.acjk path[clip-path]");
		if (list1&&list1.length&&list2&&list2.length&&(list1.length==list2.length))
		{
			// come here only once
			km=list2.length;
			for (k=0;k<km;k++)
			{
				list2[k].style.animation="none";
				list2[k].style.stroke="none";
				list2[k].style.fill="none";
				// data-d attribute is already set in theory
				list2[k].removeAttribute("clip-path");
				list2[k].removeAttribute("pathLength");
				list2[k].setAttributeNS(null,"d",list1[k].getAttribute("d"));
			}
			//forceReflow(); // necessary?
		}
		list=idocument.querySelectorAll("svg.acjk path:not([id])");
		if (list&&(km=list.length))
		{
			for (k=0;k<km;k++)
			{
				list[k].style.fill="none";
				delay=parseInt(list[k].getAttributeNS(null,"data-d"));
				currentStrokes[ks]=list[k];
				currentRun[ks]=setTimeout("pitifulOne("+ks+")",(delay+dt)*1000);
				ks++;
			}
		}
	}
}
function clearPitiful()
{
	var k,km;
	km=currentRun.length;
	for (k=0;k<km;k++) clearTimeout(currentRun[k]);
	currentRun=[];
	km=currentStrokes.length;
	for (k=0;k<km;k++) currentStrokes[k].style.fill="none";
	currentStrokes=[];
}
function pitifulTrick()
{
	// detect if the browser started the animation
	var s,d,list,k,km,iframe;
	iframe=document.getElementById('a').querySelector("iframe");
	if (!iframe) return;
	// clip-path attribute still exists here
	list=iframe.contentDocument.querySelectorAll("svg.acjk path[clip-path]");
	if (list&&(km=list.length))
	{
		s=window.getComputedStyle(list[0],null);
		d=parseInt(s.getPropertyValue("stroke-dashoffset"));
		if (d==3339)
		{
			// stroke-dashoffset is still 3339 => animation not done or poorly done
			pitiful=1;
		}
		else pitiful=0;
	}
	// pitiful=1; // for testing only
	if (pitiful>0) pitifulSeveral(-1);
}
function setAnimation(iframe)
{
	var iframe,iframes,ki,kim,delay,idocument,svg,list,k,km,style;
	iframe.setAttribute("data-ready","1"); // iframe is ready
	iframes=document.getElementById('a').getElementsByTagName("iframe");
	if (!iframes||!iframes.length) return;
	// assume iframes contains only error-free iframes
	kim=iframes.length;
	// check if all other iframes are ready too
	for (ki=0;ki<kim;ki++)
		if (iframes[ki].getAttribute("data-ready")=="0") return;
	// all iframes are ready, thus set delays
	// look inside all iframes and sum up the delays
	delay=0;
	if (iframes[0].getAttribute("data-done")=="1") return; // 1st done => all done
	for (ki=0;ki<kim;ki++)
	{
		iframes[ki].setAttribute("data-done","1");
		idocument=iframes[ki].contentDocument;
		svg=idocument.querySelector("svg.acjk");
		if (svg) // always in theory
		{
			list=svg.querySelectorAll("path:not([id])");
			if (list&&(km=list.length))
			{
				delayK=0;
				for (k=0;k<km;k++)
				{
					delayK=getDelay(list[k]);
					style=list[k].getAttributeNS(null,'style');
					style=style.replace(/--d:[^;]+;/,"--d:"+(delay+delayK)+"s;");
					list[k].setAttributeNS(null,'style',style);
					list[k].setAttributeNS(null,"data-d",(delay+delayK)+'');
				}
				delay+=delayK;
			}
		}
	}
	// forceReflow(); // necessary?
	// come here only once soon after all iframes are ready and done
	// hack for pitiful browser that cannot animate svg
	if (pitiful<0)
	{
		// previous iframes were destroyed
		// clear previous setTimeout
		if (currentPitiful) clearTimeout(currentPitiful);
		currentPitiful=setTimeout(pitifulTrick,1100);
	}
	else if (pitiful>0) pitifulSeveral(0);
}
function doSvgError(c,lang)
{
	var e,p,s;
	p=document.getElementById("a"); // parent container
	// use iframe to store the svg
	e=document.createElement("div");
	e.className="svgDivError";
	if (lang=="zh-hant") s=c+" is not in our traditional Chinese repository";
	else if (lang=="zh-hans") s=c+" is not in our simplified Chinese repository";
	else s=c+" is not in our Japanese repository";
	e.innerHTML=s;
	p.appendChild(e);
}
function doSvg(f)
{
	var e,p;
	p=document.getElementById("a"); // parent container
	// use iframe to store the svg
	e=document.createElement("iframe");
	e.setAttribute("data-ready","0"); // not ready
	e.setAttribute("data-done","0"); // not done
	e.onload=function(){setAnimation(this);}
	e.src=f;
	p.appendChild(e);
}
function cleanString(x)
{
	// keep no more than 4 characters
	// don't put this function as oninput function of input element
	// because it disturbs asian language IME
	var data;
	data=x;
	// \u200B-\u200D\uFEFF are the zero-length characters
	data=data.replace(/[0-9+*.:?!\s\u200B-\u200D\uFEFF]/g,'');
	data=magicSubstring(data,0,4);
	return data;
}
function generateStroke(data)
{
	// do what is necessary when a user does something
	var data,lang,langSuffix,a,k,km;
	lang="ja";
	// reset display
	if (pitiful>0) clearPitiful();
	status(msg[0]);
	document.getElementById('a').innerHTML=""; // destroy previous iframes
    // get data from the input field
  data=cleanString(data);
	if (!data)
	{
		status(msg[2]);
		return;
	}
  langSuffix="Ja";
	k=0;
	a=magicStringToArray(data);
	km=a.length;
	//RegExp('(20043)|(21450)|(27665)|(29995)|(30001)|(30002)|(30003)|(21450)|(30011)|(31899)|(37325)|(37340)').test(a[k].codePointAt(0))
	const jaspecial = [20043, 21450, 27665, 29995, 30001, 30002, 30003, 21450, 30011, 31899, 37325, 37340];
	for (k=0;k<km;k++){
		if (jaspecial.includes(a[k].codePointAt(0))) {
				console.log('Detected special');
				doSvg("./svgsJaSpecial/"+a[k].codePointAt(0)+".svg");
	 	} else if (RegExp('[\u3041-\u3096\u30A0-\u30FF]').test(a[k])) {
				console.log('Detected hiragana');
				doSvg("./svgsKana/"+a[k].codePointAt(0)+".svg");
	 	} else if (RegExp('[\u3400-\u4DB5\u4E00-\u9FCB\uF900-\uFA6A]').test(a[k])) {
				console.log('Detected kanji');
				doSvg("./svgs"+langSuffix+"/"+a[k].codePointAt(0)+".svg");
	 } else { doSvgError(a[k],lang); }
 }
}
function scrollToOk()
{
	var top,height,okTop;
	top=document.getElementById('a').offsetTop;
	okTop=document.getElementById('ok').offsetTop;
	height=document.getElementById('a').getBoundingClientRect().height;
	if (window.innerHeight>(top+height)) window.scrollTo(0,0);
    else window.scrollTo(0,okTop-8);
}

function loadInput ()
{
	var input, value;
	input = document.getElementById("kanji");
	value = input.value;
	generateStroke(value);
}

</script>
</head>
<body>
	<div class="flex vertical horizontal center column" id="header" style="">
		<p class="matter-h1 title" style="">KANJI GENERATOR</p>
		<p class="matter-h6">forked from AnimCJK <a href="https://raw.githubusercontent.com/parsimonhi/animCJK/master/licenses/COPYING.txt" target="_blank">(license)</a></p>
		<p class="matter-h6">modified by Edbert Eliezer <a href="https://choosealicense.com/licenses/gpl-3.0/" target="_blank">(license)</a></p>
	</div>
	<div class="flex vertical horizontal center" style="margin-bottom:40px;">
		<label class="matter-textfield-outlined" style="--matter-onsurface-rgb: 255, 255, 255; margin:0; margin-right:20px;">
			<span class="matter-tooltip"style="--matter-onsurface-rgb: 30, 30, 30;"><span id="tooltip-id" aria-hidden="true">Maximum 4 Japanese Kanji</span></span>
			<input placeholder=" "/ id="kanji">
	    <span>Insert Kanji</span>
		</label>
		<button type="button" id="kanji-button" class="matter-button-contained" onclick="loadInput()">OK</button>
	</div>
	<div id="a" class="several orange light"></div>
	<script>
		document.getElementById("kanji").addEventListener("keyup",function(event) {
			event.preventDefault();
			if (event.keyCode==13) loadInput();
		},false);
	</script>
</body>
</html>
